input {
  # Beats input (Filebeat, Winlogbeat, etc.)
  beats {
    port => 5044
    type => "beats"
  }

  # Syslog input
  tcp {
    port => 5000
    type => "syslog"
  }

  udp {
    port => 5000
    type => "syslog"
  }

  # HTTP input for webhook/API
  http {
    port => 8080
    type => "http"
  }
}

filter {
  # Add timestamp
  mutate {
    add_field => { "[@metadata][index_date]" => "%{+YYYY.MM.dd}" }
  }

  # Parse syslog messages
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGLINE}" }
    }
    
    date {
      match => [ "timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }

  # Parse common log formats
  if [type] == "beats" {
    if [message] =~ /^\{/ {
      json {
        source => "message"
      }
    }
  }

  # GeoIP enrichment for IP addresses
  if [source_ip] {
    geoip {
      source => "source_ip"
      target => "source_geo"
    }
  }

  if [destination_ip] {
    geoip {
      source => "destination_ip"
      target => "destination_geo"
    }
  }

  # Add tags for better filtering
  if [message] =~ /(?i)(error|exception|fatal)/ {
    mutate {
      add_tag => [ "error" ]
    }
  }

  if [message] =~ /(?i)(warn|warning)/ {
    mutate {
      add_tag => [ "warning" ]
    }
  }

  if [message] =~ /(?i)(failed|failure|denied|unauthorized)/ {
    mutate {
      add_tag => [ "security" ]
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => [ "[@version]", "host" ]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTICSEARCH_PASSWORD}"
    index => "logstash-beats-%{[@metadata][index_date]}"
    manage_template => true
    template_name => "logstash"
    template_overwrite => true
  }

  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
